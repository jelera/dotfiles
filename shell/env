#!/usr/bin/env bash
# Environment Variables Loader
# This file detects the platform and loads the appropriate environment files
# Loaded by both bash and zsh

# Get the directory where this script is located
# Works in both bash (BASH_SOURCE) and zsh (${(%):-%x})
if [[ -n "${BASH_SOURCE[0]}" ]]; then
    # Bash
    DOTFILES_SHELL_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
elif [[ -n "${ZSH_VERSION}" ]]; then
    # Zsh
    DOTFILES_SHELL_DIR="$(cd "$(dirname "${(%):-%x}")" && pwd)"
else
    # Fallback: assume standard location
    DOTFILES_SHELL_DIR="${HOME}/.config/dotfiles/shell"
fi
DOTFILES_ENV_DIR="${DOTFILES_SHELL_DIR}/env.d"

# Load common environment variables (cross-platform)
if [[ -f "${DOTFILES_ENV_DIR}/common" ]]; then
    # shellcheck source=./env.d/common
    source "${DOTFILES_ENV_DIR}/common"
fi

# Detect platform and load platform-specific environment
if [[ "$OSTYPE" == "darwin"* ]]; then
    # macOS
    if [[ -f "${DOTFILES_ENV_DIR}/macos" ]]; then
        # shellcheck source=./env.d/macos
        source "${DOTFILES_ENV_DIR}/macos"
    fi
elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
    # Linux - check for specific distributions
    if [[ -f /etc/os-release ]]; then
        # shellcheck disable=SC1091
        source /etc/os-release
        case "$ID" in
            ubuntu|kubuntu|xubuntu|lubuntu|ubuntu-*|pop)
                # Ubuntu and derivatives
                if [[ -f "${DOTFILES_ENV_DIR}/ubuntu" ]]; then
                    # shellcheck source=./env.d/ubuntu
                    source "${DOTFILES_ENV_DIR}/ubuntu"
                fi
                ;;
            *)
                # Generic Linux
                if [[ -f "${DOTFILES_ENV_DIR}/linux" ]]; then
                    # shellcheck source=./env.d/linux
                    source "${DOTFILES_ENV_DIR}/linux"
                fi
                ;;
        esac
    else
        # No /etc/os-release, fall back to generic Linux
        if [[ -f "${DOTFILES_ENV_DIR}/linux" ]]; then
            # shellcheck source=./env.d/linux
            source "${DOTFILES_ENV_DIR}/linux"
        fi
    fi
else
    # Unknown OS - just load common
    echo "Warning: Unknown OS type: $OSTYPE" >&2
fi

# Cleanup
unset DOTFILES_SHELL_DIR
unset DOTFILES_ENV_DIR
