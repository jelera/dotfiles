# macOS-specific Environment Variables

# GPG configuration for macOS
# Set GPG_TTY for signing commits
# This is required for GPG to prompt for passphrases in the terminal
export GPG_TTY=$TTY

# macOS: Ensure gpg-agent uses correct pinentry
if command -v gpgconf &>/dev/null; then
    # Check if pinentry-mac is available
    if [[ -f "/opt/homebrew/bin/pinentry-mac" ]]; then
        export GPG_AGENT_INFO="${HOME}/.gnupg/S.gpg-agent:0:1"
    fi
fi

# Homebrew paths for macOS (cached to avoid slow subprocess on every shell start)
_brew_cache="${XDG_CACHE_HOME:-$HOME/.cache}/brew_shellenv.sh"
if [[ -d "/opt/homebrew" ]]; then
    _brew_bin="/opt/homebrew/bin/brew"
elif [[ -d "/usr/local/Homebrew" ]]; then
    _brew_bin="/usr/local/bin/brew"
fi
if [[ -n "$_brew_bin" ]]; then
    if [[ ! -f "$_brew_cache" ]] || [[ "$_brew_bin" -nt "$_brew_cache" ]]; then
        "$_brew_bin" shellenv > "$_brew_cache"
    fi
    source "$_brew_cache"
fi
unset _brew_bin _brew_cache

# PostgreSQL (if installed via Homebrew)
if [[ -d "/opt/homebrew/opt/postgresql@16" ]]; then
    export PATH="/opt/homebrew/opt/postgresql@16/bin:$PATH"
elif [[ -d "/Applications/Postgres.app/Contents/Versions/16" ]]; then
    # Postgres.app
    export PATH="/Applications/Postgres.app/Contents/Versions/16/bin:$PATH"
fi

# libpq (PostgreSQL client)
if [[ -d "/opt/homebrew/opt/libpq" ]]; then
    export PATH="/opt/homebrew/opt/libpq/bin:$PATH"
fi

# Disable macOS fork safety for Python multiprocessing
export OBJC_DISABLE_INITIALIZE_FORK_SAFETY="YES"
