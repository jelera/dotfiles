#!/usr/bin/env bash
###############################################################################
#         Name: get_localip
#        Usage: get_localip
#
#  Description: Prints local IP address to STDOUT
#               Supports macOS and Linux (Ubuntu, Debian, CentOS, RHEL)
#
#       Author: Jose Elera (https://github.com/jelera)
#      License: MIT
###############################################################################

set -e

get_ip_macos() {
    # Try to get IP from en0 (Ethernet/WiFi) first
    ifconfig en0 2>/dev/null | awk '/inet / && !/127.0.0.1/ {print $2}' | head -n1
}

get_ip_linux_ip() {
    # Modern Linux systems with 'ip' command
    ip addr show | awk '/inet / && !/127.0.0.1/ {sub(/\/.*/, "", $2); print $2}' | head -n1
}

get_ip_linux_ifconfig() {
    # Fallback for older Linux systems with ifconfig
    ifconfig 2>/dev/null | awk '/[Bb]*cast/ {sub(/addr:/, ""); print $2}' | head -n1
}

get_ip_linux_hostname() {
    # Last resort using hostname command
    hostname -I 2>/dev/null | awk '{print $1}'
}

# Main logic
if [[ "$OSTYPE" == "darwin"* ]]; then
    # macOS
    IP=$(get_ip_macos)
elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
    # Linux - try multiple methods
    if command -v ip &>/dev/null; then
        IP=$(get_ip_linux_ip)
    elif command -v ifconfig &>/dev/null; then
        IP=$(get_ip_linux_ifconfig)
    elif command -v hostname &>/dev/null; then
        IP=$(get_ip_linux_hostname)
    fi
fi

# Output result or error
if [[ -n "$IP" ]]; then
    echo "$IP"
else
    echo "Error: Could not determine local IP address" >&2
    exit 1
fi
