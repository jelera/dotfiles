###############################################################################
#            /\/|  __      _               _
#           |/\/  / /     | |__   __ _ ___| |__  _ __ ___
#                / /      | '_ \ / _` / __| '_ \| '__/ __|
#               / /    _  | |_) | (_| \__ \ | | | | | (__
#              /_/    (_) |_.__/ \__,_|___/_| |_|_|  \___|
#
#   Maintainer: Jose Elera (https://github.com/jelera)
#      License: MIT
###############################################################################

# If not running interactively, don't do anything
[[ $- != *i* ]] && return

#----------------------------------------------------------------------------//
# => SHELL OPTIONS
#----------------------------------------------------------------------------//
# Append to history file, don't overwrite
shopt -s histappend

# Check window size after each command
shopt -s checkwinsize

# Enable extended globbing
shopt -s extglob

# Case-insensitive globbing
shopt -s nocaseglob

# Correct minor directory spelling errors
shopt -s cdspell

#----------------------------------------------------------------------------//
# => HISTORY
#----------------------------------------------------------------------------//
HISTSIZE=10000
HISTFILESIZE=20000
HISTCONTROL=ignoredups:erasedups
HISTTIMEFORMAT="%F %T "

# Share history across all sessions
shopt -s histappend
PROMPT_COMMAND="history -a; history -c; history -r; $PROMPT_COMMAND"

#----------------------------------------------------------------------------//
# => COLORS
#----------------------------------------------------------------------------//
txtrst='\e[0m'    # Text Reset
# Regular colors
txtblk='\e[0;30m' # Black
txtred='\e[0;31m' # Red
txtgrn='\e[0;32m' # Green
txtylw='\e[0;33m' # Yellow
txtblu='\e[0;34m' # Blue
txtpur='\e[0;35m' # Purple
txtcyn='\e[0;36m' # Cyan
txtwht='\e[0;37m' # White

# Bold colors
bldblk='\e[1;30m' # Black - Bold
bldred='\e[1;31m' # Red
bldgrn='\e[1;32m' # Green
bldylw='\e[1;33m' # Yellow
bldblu='\e[1;34m' # Blue
bldpur='\e[1;35m' # Purple
bldcyn='\e[1;36m' # Cyan
bldwht='\e[1;37m' # White

#----------------------------------------------------------------------------//
# => PROMPT
#----------------------------------------------------------------------------//
# Git prompt function
parse_git_branch() {
    git branch 2>/dev/null | grep '^*' | colrm 1 2
}

# Simple, clean prompt with git branch
PS1="\n\[$bldgrn\]\u@\h\[$txtrst\] \[$txtpur\][\A]\[$txtrst\] [\[$txtgrn\]\w\[$txtrst\]]\[$txtylw\]\$(parse_git_branch)\[$txtrst\]\n\[$txtpur\]$\[$txtrst\] "

#----------------------------------------------------------------------------//
# => SOURCES
#----------------------------------------------------------------------------//
# Dotfiles directory (update if different)
DOTFILES_DIR="${HOME}/.config/dotfiles"

# Source shared shell configuration
[[ -f "${DOTFILES_DIR}/shell/env" ]] && source "${DOTFILES_DIR}/shell/env"
[[ -f "${DOTFILES_DIR}/shell/alias" ]] && source "${DOTFILES_DIR}/shell/alias"
[[ -f "${DOTFILES_DIR}/shell/functions" ]] && source "${DOTFILES_DIR}/shell/functions"

#----------------------------------------------------------------------------//
# => COMPLETION
#----------------------------------------------------------------------------//
# Enable bash completion
if [[ -f /etc/bash_completion ]]; then
    source /etc/bash_completion
elif [[ -f /usr/local/etc/bash_completion ]]; then
    source /usr/local/etc/bash_completion
fi

# Homebrew completion (macOS)
if type brew &>/dev/null; then
    HOMEBREW_PREFIX="$(brew --prefix)"
    if [[ -r "${HOMEBREW_PREFIX}/etc/profile.d/bash_completion.sh" ]]; then
        source "${HOMEBREW_PREFIX}/etc/profile.d/bash_completion.sh"
    else
        for COMPLETION in "${HOMEBREW_PREFIX}/etc/bash_completion.d/"*; do
            [[ -r "$COMPLETION" ]] && source "$COMPLETION"
        done
    fi
fi

# Git completion
[[ -f ~/.git-completion.bash ]] && source ~/.git-completion.bash

#----------------------------------------------------------------------------//
# => MISE (VERSION MANAGER)
#----------------------------------------------------------------------------//
# Initialize mise for bash
if command -v mise &>/dev/null; then
    eval "$(mise activate bash)"
fi

#----------------------------------------------------------------------------//
# => FZF
#----------------------------------------------------------------------------//
# FZF integration
[[ -f ~/.fzf.bash ]] && source ~/.fzf.bash

# FZF completion for common commands
if command -v fzf &>/dev/null; then
    # Use fd instead of find if available
    if command -v fd &>/dev/null; then
        export FZF_DEFAULT_COMMAND='fd --type f --hidden --follow --exclude .git'
        export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
    fi
fi

#----------------------------------------------------------------------------//
# => EDITOR KEYBINDINGS
#----------------------------------------------------------------------------//
# Vi mode for command line
set -o vi

# Show mode in prompt (optional)
bind 'set show-mode-in-prompt on'
bind 'set vi-ins-mode-string \1\e[34m\2+\1\e[0m\2'
bind 'set vi-cmd-mode-string \1\e[35m\2:\1\e[0m\2'

#----------------------------------------------------------------------------//
# => LESS
#----------------------------------------------------------------------------//
# Make less more friendly
[[ -x /usr/bin/lesspipe ]] && eval "$(lesspipe)"

#----------------------------------------------------------------------------//
# => DEBIAN CHROOT
#----------------------------------------------------------------------------//
# Set variable identifying the chroot
if [[ -z "${debian_chroot:-}" ]] && [[ -r /etc/debian_chroot ]]; then
    debian_chroot=$(cat /etc/debian_chroot)
fi

#----------------------------------------------------------------------------//
# => LOCAL OVERRIDES
#----------------------------------------------------------------------------//
# Source local bashrc for machine-specific configuration
[[ -f ~/.bashrc.local ]] && source ~/.bashrc.local

# Homebrew
eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"

# Homebrew
eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
